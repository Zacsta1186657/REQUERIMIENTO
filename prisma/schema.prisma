generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id                  String             @id @default(cuid())
  email               String             @unique
  password            String
  nombre              String
  rol                 UserRole
  activo              Boolean            @default(true)
  avatar              String?
  operacionId         String?
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  operacion           Operacion?         @relation(fields: [operacionId], references: [id])
  archivosSubidos     Archivo[]          @relation("ArchivosSubidos")
  historialEstados    HistorialEstado[]
  lotesRecibidos      Lote[]             @relation("Receptor")
  modificacionesItems ModificacionItem[]
  notificaciones      Notificacion[]
  requerimientos      Requerimiento[]    @relation("Solicitante")
  itemsValidados      RequerimientoItem[] @relation("ItemsValidados")

  @@map("users")
}

model Operacion {
  id             String          @id @default(cuid())
  nombre         String
  codigo         String          @unique
  activo         Boolean         @default(true)
  usuarios       User[]
  requerimientos Requerimiento[]

  @@map("operaciones")
}

model CentroCosto {
  id             String          @id @default(cuid())
  nombre         String
  codigo         String          @unique
  activo         Boolean         @default(true)
  requerimientos Requerimiento[]

  @@map("centros_costo")
}

model Categoria {
  id                 String              @id @default(cuid())
  nombre             String              @unique
  activo             Boolean             @default(true)
  productos          Producto[]
  requerimientoItems RequerimientoItem[]

  @@map("categorias")
}

model UnidadMedida {
  id                 String              @id @default(cuid())
  nombre             String
  abreviatura        String              @unique
  activo             Boolean             @default(true)
  requerimientoItems RequerimientoItem[]

  @@map("unidades_medida")
}

model Marca {
  id        String     @id @default(cuid())
  nombre    String     @unique
  activo    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  modelos   Modelo[]
  productos Producto[]

  @@map("marcas")
}

model Modelo {
  id        String     @id @default(cuid())
  nombre    String
  marcaId   String
  activo    Boolean    @default(true)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt
  marca     Marca      @relation(fields: [marcaId], references: [id])
  productos Producto[]

  @@unique([marcaId, nombre])
  @@map("modelos")
}

model Producto {
  id                 String              @id @default(cuid())
  numeroParte        String?             @unique
  descripcion        String
  activo             Boolean             @default(true)
  categoriaId        String
  marcaId            String
  modeloId           String
  categoria          Categoria           @relation(fields: [categoriaId], references: [id])
  marca              Marca               @relation(fields: [marcaId], references: [id])
  modelo             Modelo              @relation(fields: [modeloId], references: [id])
  requerimientoItems RequerimientoItem[]

  @@map("productos")
}

model Requerimiento {
  id               String              @id @default(cuid())
  numero           String              @unique
  fecha            DateTime            @default(now())
  motivo           String
  comentarios      String?
  estado           RequerimientoStatus @default(BORRADOR)
  createdAt        DateTime            @default(now())
  updatedAt        DateTime            @updatedAt
  solicitanteId    String
  operacionId      String
  centroCostoId    String
  archivos         Archivo[]
  historialEstados HistorialEstado[]
  lotes            Lote[]
  notificaciones   Notificacion[]
  items            RequerimientoItem[]
  centroCosto      CentroCosto         @relation(fields: [centroCostoId], references: [id])
  operacion        Operacion           @relation(fields: [operacionId], references: [id])
  solicitante      User                @relation("Solicitante", fields: [solicitanteId], references: [id])

  @@index([estado])
  @@index([solicitanteId])
  @@index([fecha])
  @@map("requerimientos")
}

model RequerimientoItem {
  id                  String             @id @default(cuid())
  numeroParte         String?
  descripcion         String
  marca               String?
  modelo              String?
  cantidadSolicitada  Int
  cantidadAprobada    Int?
  serial              String?
  enStock             Boolean?
  requiereCompra      Boolean?
  motivoStock         String?
  fechaEstimadaCompra DateTime?
  validadoCompra      Boolean?
  validadoPorId       String?
  fechaValidacion     DateTime?
  observacionCompra   String?
  compraRecibida      Boolean?
  fechaRecepcionCompra DateTime?
  estadoItem          ItemStatus         @default(PENDIENTE_CLASIFICACION)
  eliminado           Boolean            @default(false)
  createdAt           DateTime           @default(now())
  updatedAt           DateTime           @updatedAt
  requerimientoId     String
  categoriaId         String
  unidadMedidaId      String
  productoId          String?
  loteItems           LoteItem[]
  modificaciones      ModificacionItem[]
  categoria           Categoria          @relation(fields: [categoriaId], references: [id])
  producto            Producto?          @relation(fields: [productoId], references: [id])
  requerimiento       Requerimiento      @relation(fields: [requerimientoId], references: [id], onDelete: Cascade)
  unidadMedida        UnidadMedida       @relation(fields: [unidadMedidaId], references: [id])
  validadoPor         User?              @relation("ItemsValidados", fields: [validadoPorId], references: [id])

  @@index([requerimientoId])
  @@map("requerimiento_items")
}

model Lote {
  id                  String        @id @default(cuid())
  numero              Int
  estado              LoteStatus    @default(PENDIENTE)
  fechaDespacho       DateTime?
  fechaEntrega        DateTime?
  transportista       String?
  destino             String?
  confirmadoRecepcion Boolean       @default(false)
  observaciones       String?
  createdAt           DateTime      @default(now())
  updatedAt           DateTime      @updatedAt
  requerimientoId     String
  receptorId          String?
  items               LoteItem[]
  receptor            User?         @relation("Receptor", fields: [receptorId], references: [id])
  requerimiento       Requerimiento @relation(fields: [requerimientoId], references: [id], onDelete: Cascade)

  @@unique([requerimientoId, numero])
  @@map("lotes")
}

model LoteItem {
  id                  String            @id @default(cuid())
  cantidadEnviada     Int
  loteId              String
  requerimientoItemId String
  cantidadRecibida    Int?
  lote                Lote              @relation(fields: [loteId], references: [id], onDelete: Cascade)
  requerimientoItem   RequerimientoItem @relation(fields: [requerimientoItemId], references: [id], onDelete: Cascade)

  @@unique([loteId, requerimientoItemId])
  @@map("lote_items")
}

model HistorialEstado {
  id              String               @id @default(cuid())
  estadoAnterior  RequerimientoStatus?
  estadoNuevo     RequerimientoStatus
  comentario      String?
  createdAt       DateTime             @default(now())
  requerimientoId String
  usuarioId       String
  requerimiento   Requerimiento        @relation(fields: [requerimientoId], references: [id], onDelete: Cascade)
  usuario         User                 @relation(fields: [usuarioId], references: [id])

  @@index([requerimientoId])
  @@map("historial_estados")
}

model ModificacionItem {
  id                  String            @id @default(cuid())
  campo               String
  valorAnterior       String
  valorNuevo          String
  motivo              String?
  createdAt           DateTime          @default(now())
  requerimientoItemId String
  usuarioId           String
  requerimientoItem   RequerimientoItem @relation(fields: [requerimientoItemId], references: [id], onDelete: Cascade)
  usuario             User              @relation(fields: [usuarioId], references: [id])

  @@map("modificaciones_items")
}

model Notificacion {
  id              String           @id @default(cuid())
  tipo            NotificationType
  titulo          String
  mensaje         String
  leida           Boolean          @default(false)
  createdAt       DateTime         @default(now())
  usuarioId       String
  requerimientoId String?
  requerimiento   Requerimiento?   @relation(fields: [requerimientoId], references: [id], onDelete: Cascade)
  usuario         User             @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId, leida])
  @@map("notificaciones")
}

model Archivo {
  id               String         @id @default(cuid())
  nombre           String
  nombreAlmacenado String         @unique
  tipo             TipoArchivo
  mimeType         String
  tamanio          Int
  extension        String
  ruta             String
  descripcion      String?
  activo           Boolean        @default(true)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  subidoPorId      String
  requerimientoId  String?
  requerimiento    Requerimiento? @relation(fields: [requerimientoId], references: [id])
  subidoPor        User           @relation("ArchivosSubidos", fields: [subidoPorId], references: [id])

  @@index([requerimientoId])
  @@index([subidoPorId])
  @@index([tipo])
  @@map("archivos")
}

enum UserRole {
  TECNICO
  SEGURIDAD
  OPERACIONES
  GERENCIA
  LOGISTICA
  ADMINISTRACION
  RECEPTOR
  ADMIN
}

enum RequerimientoStatus {
  BORRADOR
  CREADO
  VALIDACION_SEGURIDAD
  APROBADO_SEGURIDAD
  RECHAZADO_SEGURIDAD
  VALIDACION_GERENCIA
  APROBADO_GERENCIA
  RECHAZADO_GERENCIA
  REVISION_LOGISTICA
  EN_COMPRA
  APROBADO_ADM
  RECHAZADO_ADM
  LISTO_DESPACHO
  ENVIADO
  ENTREGADO_PARCIAL
  ENTREGADO
}

enum LoteStatus {
  PENDIENTE
  PREPARANDO
  DESPACHADO
  EN_TRANSITO
  ENTREGADO
}

enum ItemStatus {
  PENDIENTE_CLASIFICACION
  EN_STOCK
  REQUIERE_COMPRA
  PENDIENTE_VALIDACION_ADMIN
  APROBADO_COMPRA
  RECHAZADO_COMPRA
  LISTO_PARA_DESPACHO
  DESPACHO_PARCIAL
  DESPACHADO
}

enum NotificationType {
  REQUERIMIENTO_CREADO
  APROBACION_PENDIENTE
  ESTADO_CAMBIO
  RECHAZADO
  LISTO_DESPACHO
  ENTREGADO
}

enum TipoArchivo {
  FACTURA
  GUIA_REMISION
  ORDEN_COMPRA
  COTIZACION
  DOCUMENTO_GENERAL
  OTRO
}
